# SDK Cross Promotion Bid API

## API History

|Version|Description|
|----|----|
| v1 |  |

* API used for OM-SDK headbidding to load cross-promotion ads, returning http status 200 for success, non-200 for no filling or failure
* API based on [OpenRTB protocol v2.5](https://www.iab.com/wp-content/uploads/2016/03/OpenRTB-API-Specification-Version-2-5-FINAL.pdf)
* Request header `Content-Type: application/json` is reqiured
* The API accepts request body compression, in either `gzip` or `deflate` format, specified by the request header `Content-Encoding`, which is mandatory in this case.

## BidderToken

* BidderToken use json + zlib + base64 to generate, and pass in BidRequest.user.id

```json
{
  "sdkv": "6.2.1",  // sdk version
  "fit": 1324573120, // int
  "flt": 1234482484, // int
  "iap": 1.3,   // float, (optional)
  "session": "string", // session ID
  "uid": "string",     // User ID
  "did": "string",     // device ID
  "dtype": 1, // deviceID type
  "afid": "string",   // appsflyerID (optional)
  "ng": 1,     // int, No GooglePlay (optional)
  "zo": 480,   // int, zone offset in minutes. Beijing: zo=480
  "jb": 1,     // int, jailbreak status, 0:normal,1:break (optional)
  "brand": "", // string , device brand (optional)
  "fm": 123, // int, free disk memory, unit M
  "battery": 85, // int, Remaining battery percentage
  "btch": 1, // int, Is charging, 0:No,1:Yes (optional)
  "lowp": 1, // int, Low battery mode, 0:No,1:Yes (optional)
  "lcy": "CN" // string, local country
}
```

## BidRequest

```json
{
  "id": "string", // platform's auction identifier,
  "imp": [ // slots to bid on
    {
      "id": "0", // platform's identifier for this slot auction
      "tagid": "string", // Placement ID or Placement Name
      "banner": { // (optional)
        "w": 230, // int, width
        "h": 50 // int, height
      },
      "native": { // (optional)
        "w": 1024,// int, width
        "h": 768  // int, height
      },
      "video": { // (optional)
        "w": 1080,// int, width
        "h": 1920 // int, height
      }
    }
  ],
  "app": {
    "id": "string", // PublisherApp.appKey of AdTiming
    "ver": "13.3",  // app version
    "bundle": "184791379" // app bundle (iOS: Numberic ID, Android: Package Name)
  },
  "device": {
    "ifa": "{IDFA}", // idfa or gaid or oaid
    "ua": "{USER-AGENT}", // device user-agent, required
    "make": "{MAKE}", // string, (optional)
    "model": "{MODEL}", // string, (optional)
    "os": "iOS", // iOS or Android
    "osv": "13.3", // OS Version
    "language": "zh_CN", //
    "mccmnc": "",  //
    "carrier": "",  //
    "connectiontype": 1, // int,
    // Do not send ip or ipv6 if you are requesting bids from the client device
    // For server-side bid requests only, set one of ip or ipv6
    "ip": "", // ?string, // device IPv4 (optional, server-side bidding only)
    "ipv6": "", // ?string, // device IPv6 (optional, server-side bidding only)
    "dnt": 0, // ?int, // 0: normal, 1: do-not-track
  },
  "regs": { // regulations object, optional
    "coppa": 1, // Flag indicating if this request is subject to the COPPA regulations established by the USA FTC, where 0 = no, 1 = yes, optional
    "ext": {
      "gdpr": 1, // GDPR, 0 = no/OFF, 1 = yes/ON, optional
      "ccpa": 1  // CCPA, 0 = no/OFF, 1 = yes/ON, optional
    }
  },
  "user": {
    "id": "string", // Audience Network Identity Token, generated by sdk getBidderToken()
  },
  "at": 1, // int // auction type: 1: First Price, 2: Second Price
  "tmax": 500, // int, // auction timeout, ms
  "test": 1 // 0: normal, 1: test mode (we bid $99.99, but don't pay out)  (optional)
}
```

## BidResponse

```json
{
  "id": "string", // platform's request identifier
  "seatbid": [
    {
      "bid": [
        {
          "id": "string", // Our identifier for this bid
          "impid": "string", // platform's identifier for this slot auction
          "price": 0.5, // float, Our bid price, in USD cents, CPM basis
          "adm": "string", // Our creative - see Rendering The Ad
          "nurl": "string", // URL to get if we win the impression
          "lurl": "string" // URL to get if we lose the impression
        }
      ]
    }
  ],
  "bidid": "string", // Our identifier for this response
  "cur": "string", // bid currency: USD
}
```

## adm

* adm is a json in string format

```json
{
  "type": "ID",
  "payload": "string token for payload",
}
```

竞价响应会提供得标 nurl。您需要在 nurl 中填充结算价格：

```string
https://s.openmediation.com/cp/nurl?xxx&wprice=${AUCTION_PRICE}&lcode=0
```

* `${AUCTION_PRICE}`：您应将此值替换为采用我们相同竞价单位的竞拍结算价格（即基于千次展示费用的美元金额）。

竞价响应会提供得标 lurl。您需要在 lurl 中填充结算价格：

```string
https://s.openmediation.com/cp/nurl?xxx&wprice=${AUCTION_PRICE}&lcode=${AUCTION_LOSS}
```

* `${AUCTION_LOSS}`：您应将此值替换为 ORTB 失标代码。
* `${AUCTION_PRICE}`：您应将此值替换为采用我们相同竞价单位的竞拍结算价格（即基于千次展示费用的美元金额）

Below is a list of different **Loss Codes** and corresponding **Loss Reasons**.

| Loss Reason |Description| ORTB v2.5 Loss Code|
| --- | ---| --- |
|Internal error |Internal error (e.g. when we won the auction, but our ad failed to load)| 1|
|Invalid bid response | Bid is invalid (but on-time, not a no-bid, and valid enough that you can extract the nurl) | 3|
| Bid timeout * | Bid response received, but too late for auction cutoff | 2 |
|Bid was Below Auction Floor|Bidding price was below current auction floor. |100|
|Not highest RTB bidder| Another bidder beat us, including synthetic bids (e.g. non-RTB exchanges), if they are entered into the same auction.|102|
|Lost to a Bid for a PMP Deal|A PMP (tag or traditional waterfall) deal was picked over the bidders in the auction.|103|
| Win | We won the full decision tree, and tag was placed on page (web) or ad object was cached (app). Viewable impression may still not result. | 0 |
